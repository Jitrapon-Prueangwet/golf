<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tournament Calendar</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <!-- FullCalendar CSS and JS -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.js"></script>
    
    <style>
        .calendar-container {
            max-width: 800px;
            margin: 2rem auto;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
            padding: 2rem;
        }
        .calendar-header {
            display: flex;
            align-items: center;
            margin-bottom: 2rem;
        }
        .calendar-header h1 {
            color: var(--hermes-orange);
            font-size: 2rem;
            margin: 0;
        }
        .tournament-list {
            list-style: none;
            padding: 0;
        }
        .tournament-item {
            border-bottom: 1px solid #eee;
            padding: 1rem 0;
        }
        .tournament-item:last-child {
            border-bottom: none;
        }
        .tournament-title {
            font-size: 1.2rem;
            color: var(--hermes-orange-dark);
            font-weight: bold;
        }
        .tournament-date {
            color: #666;
            font-size: 1rem;
        }
        .tournament-location {
            color: #333;
            font-size: 1rem;
        }
        .auth-container {
            text-align: center;
            margin: 2rem 0;
        }
        .auth-button {
            background: var(--hermes-orange);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .auth-button:hover {
            background: var(--hermes-orange-dark);
        }
        .loading {
            text-align: center;
            color: var(--hermes-orange);
            font-size: 1.2rem;
            margin: 2rem 0;
        }
        .error-message {
            color: #dc3545;
            text-align: center;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <div class="auth-container" id="auth-container"></div>
    <div class="calendar-container" id="calendar-app" style="display:none;">
    <div class="calendar-container">
        <div class="calendar-header">
            <a href="index.html" class="back-icon" style="margin-right:1rem;">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--hermes-orange)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
            </a>
            <h1>Tournament Calendar</h1>
        </div>
        
            <!-- Month and Year Selectors -->
            <div style="display:flex; gap:1rem; align-items:center; margin-bottom:1.5rem;">
                <select id="month-select" style="padding:0.5rem; border-radius:5px; border:1px solid #ccc; font-size:1rem;"></select>
                <select id="year-select" style="padding:0.5rem; border-radius:5px; border:1px solid #ccc; font-size:1rem;"></select>
            </div>

            <!-- Tournament Input Form -->
            <form id="tournament-form" autocomplete="off" style="margin-bottom:2rem; display:flex; gap:1rem; flex-wrap:wrap; align-items:center;">
                <input type="text" id="title" placeholder="Tournament Title" required autocomplete="off" style="flex:2; padding:0.5rem; border-radius:5px; border:1px solid #ccc;">
                <input type="date" id="date" required style="flex:1; padding:0.5rem; border-radius:5px; border:1px solid #ccc;">
                <input type="text" id="location" placeholder="Location" required style="flex:2; padding:0.5rem; border-radius:5px; border:1px solid #ccc;">
                <button type="submit" class="auth-button" style="flex:1; min-width:120px;">Add Tournament</button>
            </form>

            <!-- Dynamic Calendar -->
            <div id="custom-calendar">
                <div id="calendar-header-bar" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                    <!-- Calendar header will be rendered here -->
                </div>
                <table style="width:100%; border-collapse:collapse; background:#fff;">
                    <thead>
                        <tr style="border-bottom:1px solid #ddd;">
                            <th style="padding:0.5rem 0; color:#444; font-size:1rem; letter-spacing:0.1em;">SUN</th>
                            <th style="padding:0.5rem 0; color:#444; font-size:1rem; letter-spacing:0.1em;">MON</th>
                            <th style="padding:0.5rem 0; color:#444; font-size:1rem; letter-spacing:0.1em;">TUE</th>
                            <th style="padding:0.5rem 0; color:#444; font-size:1rem; letter-spacing:0.1em;">WED</th>
                            <th style="padding:0.5rem 0; color:#444; font-size:1rem; letter-spacing:0.1em;">THU</th>
                            <th style="padding:0.5rem 0; color:#444; font-size:1rem; letter-spacing:0.1em;">FRI</th>
                            <th style="padding:0.5rem 0; color:#444; font-size:1rem; letter-spacing:0.1em;">SAT</th>
                        </tr>
                    </thead>
                    <tbody id="calendar-body">
                        <!-- Calendar days will be rendered here by JS -->
                    </tbody>
                </table>
            </div>

            <!-- Modal for adding tournament by clicking a date -->
            <div id="modal-bg" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.25); z-index:1000; align-items:center; justify-content:center;">
                <div id="modal-form" style="background:#fff; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.15); padding:2rem; min-width:300px; max-width:90vw; position:relative;">
                    <button id="modal-close" style="position:absolute; top:0.5rem; right:0.5rem; background:none; border:none; font-size:1.5rem; cursor:pointer;">&times;</button>
                    <h2 style="margin-top:0;">Add Tournament</h2>
                    <form id="modal-tournament-form" autocomplete="off">
                        <input type="text" id="modal-title" placeholder="Tournament Title" required autocomplete="off" style="width:100%; margin-bottom:1rem; padding:0.5rem; border-radius:5px; border:1px solid #ccc;">
                        <input type="text" id="modal-location" placeholder="Location" required style="width:100%; margin-bottom:1rem; padding:0.5rem; border-radius:5px; border:1px solid #ccc;">
                        <input type="date" id="modal-date" required style="width:100%; margin-bottom:1rem; padding:0.5rem; border-radius:5px; border:1px solid #ccc;">
                        <button type="submit" class="auth-button" style="width:100%;">Add Tournament</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Supabase Setup ---
        const supabaseUrl = 'https://tntltflyjoqaprjrzeju.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRudGx0Zmx5am9xYXByanJ6ZWp1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY5NzM3MzMsImV4cCI6MjA2MjU0OTczM30.5wzvob6A-QqpEnKM6Solmexm5NAcCNGMeAVSAXBLJxM';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // --- Auth UI ---
        const calendarApp = document.getElementById('calendar-app');
        let currentUser = null;

        async function checkAuth() {
            const { data: { user } } = await supabase.auth.getUser();
            currentUser = user;
            if (user) {
                calendarApp.style.display = '';
                renderCalendar(parseInt(monthSelect.value), parseInt(yearSelect.value));
            } else {
                // Redirect to login page if not authenticated
                window.location.href = 'login.html';
            }
        }
        checkAuth();
        supabase.auth.onAuthStateChange((_event, session) => {
            checkAuth();
        });

        // --- Month and Year Selectors ---
        const monthNames = [
            'January', 'February', 'March', 'April', 'May', 'June',
            'July', 'August', 'September', 'October', 'November', 'December'
        ];
        const monthSelect = document.getElementById('month-select');
        const yearSelect = document.getElementById('year-select');
        const currentYear = new Date().getFullYear();
        for (let y = 2025; y <= currentYear + 20; y++) {
            const opt = document.createElement('option');
            opt.value = y;
            opt.textContent = y;
            yearSelect.appendChild(opt);
        }
        for (let m = 0; m < 12; m++) {
            const opt = document.createElement('option');
            opt.value = m;
            opt.textContent = monthNames[m];
            monthSelect.appendChild(opt);
        }
        monthSelect.value = new Date().getMonth();
        yearSelect.value = new Date().getFullYear();

        // --- Fetch tournaments from Supabase for a month/year ---
        async function fetchTournaments(month, year) {
            if (!currentUser) return [];
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const fromDate = `${year}-${(month+1).toString().padStart(2, '0')}-01`;
            const toDate = `${year}-${(month+1).toString().padStart(2, '0')}-${daysInMonth.toString().padStart(2, '0')}`;
            let { data, error } = await supabase
                .from('tournaments')
                .select('*')
                .eq('user_id', currentUser.id)
                .gte('date', fromDate)
                .lte('date', toDate);
            return data || [];
        }

        // --- Insert a new tournament into Supabase ---
        async function addTournament(title, date, location) {
            if (!currentUser) return;
            let { data, error } = await supabase
                .from('tournaments')
                .insert([{ title, date, location, user_id: currentUser.id }]);
            return data;
        }

        // --- Supabase Update and Delete Functions ---
        async function updateTournament(id, title, date, location) {
            if (!currentUser) return;
            let { data, error } = await supabase
                .from('tournaments')
                .update({ title, date, location })
                .eq('id', id)
                .eq('user_id', currentUser.id);
            return data;
        }
        async function deleteTournament(id) {
            if (!currentUser) return;
            let { data, error } = await supabase
                .from('tournaments')
                .delete()
                .eq('id', id)
                .eq('user_id', currentUser.id);
            return data;
        }

        // --- Calendar Rendering ---
        async function renderCalendar(month, year) {
            // Header
            document.getElementById('calendar-header-bar').innerHTML = `
                <span style="font-size:2.5rem; font-weight:600; letter-spacing:0.1em;">${(month+1).toString().padStart(2, '0')}</span>
                <span style="font-size:2.2rem; font-weight:500; letter-spacing:0.2em;">${monthNames[month].toUpperCase()}</span>
                <span style="font-size:2.5rem; font-weight:600; letter-spacing:0.1em;">${year}</span>
            `;
            // Fetch tournaments for this month/year
            const tournaments = await fetchTournaments(month, year);
            // Days
            const daysInMonth = new Date(year, month+1, 0).getDate();
            const firstDay = new Date(year, month, 1).getDay();
            let html = '';
            let day = 1;
            for (let week = 0; week < 6; week++) {
                html += '<tr>';
                for (let d = 0; d < 7; d++) {
                    if ((week === 0 && d < firstDay) || day > daysInMonth) {
                        html += '<td style="height:60px; border:1px solid #eee;"></td>';
                    } else {
                        const dateStr = `${year}-${(month+1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                        const todaysTournaments = tournaments.filter(t => t.date === dateStr);
                        html += `<td style="vertical-align:top; height:60px; max-width:100px; width:100px; border:1px solid #eee; position:relative; cursor:pointer; overflow:hidden;" data-date="${dateStr}">
                            <div style="font-weight:600; color:#444;">${day}</div>`;
                        todaysTournaments.forEach(t => {
                            html += `<div class="tournament-badge" title="${t.title} - ${t.location}">
                                <span class="tournament-title" onclick=\"alert('Title: ${t.title}\\nLocation: ${t.location}\\nDate: ${t.date}')\">${t.title.length > 4 ? t.title.substring(0, 4) + '…' : t.title}</span>
                                <span class="tournament-actions">
                                    <button class='edit-btn' data-id='${t.id}' data-title='${t.title}' data-date='${t.date}' data-location='${t.location}'>✎</button>
                                    <button class='delete-btn' data-id='${t.id}'>🗑</button>
                                </span>
                            </div>`;
                        });
                        html += '</td>';
                        day++;
                    }
                }
                html += '</tr>';
                if (day > daysInMonth) break;
            }
            document.getElementById('calendar-body').innerHTML = html;

            // Add click event listeners to date cells
            document.querySelectorAll('#calendar-body td[data-date]').forEach(cell => {
                cell.addEventListener('click', function(e) {
                    if (e.target.classList.contains('tournament-badge') || e.target.classList.contains('edit-btn') || e.target.classList.contains('delete-btn')) return;
                    showModal(this.getAttribute('data-date'));
                });
            });
            // Edit button listeners
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    showModal(this.getAttribute('data-date'), {
                        id: this.getAttribute('data-id'),
                        title: this.getAttribute('data-title'),
                        date: this.getAttribute('data-date'),
                        location: this.getAttribute('data-location')
                    });
                });
            });
            // Delete button listeners
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', async function(e) {
                    e.stopPropagation();
                    if (confirm('Delete this tournament?')) {
                        await deleteTournament(this.getAttribute('data-id'));
                        await renderCalendar(parseInt(monthSelect.value), parseInt(yearSelect.value));
                    }
                });
            });
        }

        // --- Tournament Form Handling ---
        document.getElementById('tournament-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const title = document.getElementById('title').value.trim();
            const date = document.getElementById('date').value;
            const location = document.getElementById('location').value.trim();
            if (title && date && location) {
                await addTournament(title, date, location);
                // Parse year and month from the date and update selectors
                const [year, month] = date.split('-');
                monthSelect.value = (parseInt(month, 10) - 1).toString();
                yearSelect.value = year;
                await renderCalendar(parseInt(monthSelect.value), parseInt(yearSelect.value));
                this.reset();
            }
        });

        // --- Month/Year Change Handling ---
        monthSelect.addEventListener('change', function() {
            renderCalendar(parseInt(monthSelect.value), parseInt(yearSelect.value));
        });
        yearSelect.addEventListener('change', function() {
            renderCalendar(parseInt(monthSelect.value), parseInt(yearSelect.value));
        });

        // Initial render
        renderCalendar(parseInt(monthSelect.value), parseInt(yearSelect.value));

        // --- Modal Logic ---
        const modalBg = document.getElementById('modal-bg');
        const modalForm = document.getElementById('modal-tournament-form');
        const modalTitle = document.getElementById('modal-title');
        const modalLocation = document.getElementById('modal-location');
        const modalDate = document.getElementById('modal-date');
        const modalClose = document.getElementById('modal-close');

        let editingTournamentId = null;
        function showModal(dateStr, tournament = null) {
            modalBg.style.display = 'flex';
            if (tournament) {
                editingTournamentId = tournament.id;
                modalTitle.value = tournament.title;
                modalLocation.value = tournament.location;
                modalDate.value = tournament.date;
            } else {
                editingTournamentId = null;
                modalTitle.value = '';
                modalLocation.value = '';
                modalDate.value = dateStr;
            }
            modalTitle.focus();
        }
        function hideModal() {
            modalBg.style.display = 'none';
        }
        modalClose.onclick = hideModal;
        modalBg.onclick = function(e) { if (e.target === modalBg) hideModal(); };
        modalForm.onsubmit = async function(e) {
            e.preventDefault();
            const title = modalTitle.value.trim();
            const date = modalDate.value;
            const location = modalLocation.value.trim();
            if (title && date && location) {
                if (editingTournamentId) {
                    await updateTournament(editingTournamentId, title, date, location);
                } else {
                    await addTournament(title, date, location);
                }
                // Switch calendar to the correct month/year
                const [year, month] = date.split('-');
                monthSelect.value = (parseInt(month, 10) - 1).toString();
                yearSelect.value = year;
                await renderCalendar(parseInt(monthSelect.value), parseInt(yearSelect.value));
                hideModal();
            }
        };
    </script>
</body>
</html> 